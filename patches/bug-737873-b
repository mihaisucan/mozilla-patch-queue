# HG changeset patch
# Parent 2c5b47fc3ff0d81fcc3465fd4142f8da6baf4910
# User Tanvi Vyas <tvyas@mozilla.com>
Updated HUDService.jsm to alert about mixed content
* * *
Updated patch to account for refactor of webconsole.  Moved font color to the css files.  Alert not working yet because of issue with this.contentLocation.
* * *
Additional changes

diff --git a/browser/devtools/webconsole/HUDService.jsm b/browser/devtools/webconsole/HUDService.jsm
--- a/browser/devtools/webconsole/HUDService.jsm
+++ b/browser/devtools/webconsole/HUDService.jsm
@@ -2109,30 +2109,94 @@ HeadsUpDisplay.prototype = {
     let urlNode = this.chromeDocument.createElementNS(XUL_NS, "label");
     urlNode.setAttribute("crop", "center");
     urlNode.setAttribute("flex", "1");
     urlNode.setAttribute("title", request.url);
     urlNode.setAttribute("value", request.url);
     urlNode.classList.add("hud-clickable");
     urlNode.classList.add("webconsole-msg-body-piece");
     urlNode.classList.add("webconsole-msg-url");
-    linkNode.appendChild(urlNode);
+
+    let severity = SEVERITY_LOG;
+    let uriCreated = false;
+    let requestURIObject;
+    let contentWindowURI;
+
+    try{
+      let ioServ = Cc["@mozilla.org/network/io-service;1"].getService(Ci.nsIIOService);
+      requestURIObject = ioServ.newURI(request.url, null, null);
+      contentWindowURI = ioServ.newURI(this.contentLocation, null, null);
+      uriCreated = true;
+    } catch(e) {
+        /*
+         * catch NS_ERROR_MALFORMED_URI?
+         * if this error occurs, we skip the mixed content section and
+         * the webconsole does not warn about mixed content
+         */
+    }
+
+
+    // if the operations to create nsIURI objects for the contentWindow and request succeeeded
+    if(uriCreated) {
+
+      //requestURIScheme is the scheme of the requested content - the entry in webconsole
+      //contentWindowURIScheme is the scheme of the current page.
+      let requestURIScheme = requestURIObject.scheme;
+      let contentWindowURIScheme = contentWindowURI.scheme;
+
+      //if the console entry is mixed content
+      if(contentWindowURIScheme == "https" && requestURIScheme != "https") {
+        urlNode.classList.add("webconsole-mixed-content");
+        linkNode.appendChild(urlNode);
+
+        let mixedContentWarning = " ["+l10n.getStr("webConsoleMixedContentWarning")+"]";
+
+        //mixedContentWarning message links to a Learn More page
+        let mixedContentWarningNode = this.chromeDocument.createElement("label");
+        mixedContentWarningNode.setAttribute("value", mixedContentWarning);
+
+        //UI for mixed content warning.  Needs more work.
+        mixedContentWarningNode.classList.add("hud-clickable");
+        mixedContentWarningNode.classList.add("webconsole-msg-body");
+        mixedContentWarningNode.classList.add("webconsole-msg-url");
+        //This doesn't seem to change the font color.  Need to investigate further
+        mixedContentWarningNode.classList.add("webconsole-mixed-content-link");
+
+        linkNode.appendChild(mixedContentWarningNode);
+
+        mixedContentWarningNode.addEventListener("click", function(aEvent) {
+          this.chromeWindow.openUILinkIn("https://developer.mozilla.org/", 'tab');
+          aEvent.preventDefault();
+          aEvent.stopPropagation();
+          }.bind(this)
+        );
+
+        //If we define a SEVERITY_SECURITY in the future, switch this to SEVERITY_SECURITY
+        severity = SEVERITY_WARNING;
+
+      } else { //not mixed content
+        linkNode.appendChild(urlNode);
+      }
+
+    } else { //uriCreated failed
+      linkNode.appendChild(urlNode);
+    }
 
     let statusNode = this.chromeDocument.createElementNS(XUL_NS, "label");
     statusNode.setAttribute("value", "");
     statusNode.classList.add("hud-clickable");
     statusNode.classList.add("webconsole-msg-body-piece");
     statusNode.classList.add("webconsole-msg-status");
     linkNode.appendChild(statusNode);
 
     let clipboardText = request.method + " " + request.url;
 
     let messageNode = ConsoleUtils.createMessageNode(this.chromeDocument,
                                                      CATEGORY_NETWORK,
-                                                     SEVERITY_LOG,
+                                                     severity,
                                                      msgNode,
                                                      this.hudId,
                                                      null,
                                                      null,
                                                      clipboardText);
 
     messageNode.setAttribute("connectionId", entry.connection);
 
diff --git a/browser/locales/en-US/chrome/browser/devtools/webconsole.properties b/browser/locales/en-US/chrome/browser/devtools/webconsole.properties
--- a/browser/locales/en-US/chrome/browser/devtools/webconsole.properties
+++ b/browser/locales/en-US/chrome/browser/devtools/webconsole.properties
@@ -145,16 +145,21 @@ webConsolePositionBelow=Below
 webConsolePositionWindow=Window
 
 # LOCALIZATION NOTE (webConsoleWindowTitleAndURL): The Web Console floating
 # panel title, followed by the web page URL.
 # For RTL languages you need to set the LRM in the string to give the URL
 # the correct direction.
 webConsoleWindowTitleAndURL=Web Console - %S
 
+# LOCALIZATION NOTE (webConsoleMixedContentWarning): Message displayed after a
+# URL in the Web Console that has been flagged for Mixed Content (i.e. http
+# content in an https page)
+webConsoleMixedContentWarning=Mixed Content
+
 # LOCALIZATION NOTE (scratchpad.linkText):
 # The text used in the right hand side of the web console command line when
 # Javascript is being entered, to indicate how to jump into scratchpad mode
 scratchpad.linkText=Shift+RETURN - Open in Scratchpad
 
 # LOCALIZATION NOTE (gcliterm.instanceLabel): The console displays
 # objects using their type (from the constructor function) in this descriptive
 # string
diff --git a/browser/themes/gnomestripe/devtools/webconsole.css b/browser/themes/gnomestripe/devtools/webconsole.css
--- a/browser/themes/gnomestripe/devtools/webconsole.css
+++ b/browser/themes/gnomestripe/devtools/webconsole.css
@@ -89,16 +89,24 @@
   margin-top: 0;
   margin-bottom: 0;
   -moz-margin-start: 0;
   -moz-margin-end: 6px;
   width: 10em;
   text-align: end;
 }
 
+.webconsole-mixed-content {
+  color: #FF0000;
+}
+
+.webconsole-mixed-content-link {
+  color: #0000EE;
+}
+
 .hud-msg-node[selected="true"] > .webconsole-timestamp,
 .hud-msg-node[selected="true"] > .webconsole-location {
   color: inherit;
 }
 
 .jsterm-input-node,
 .jsterm-complete-node {
   font: 12px "DejaVu Sans Mono", monospace;
diff --git a/browser/themes/pinstripe/devtools/webconsole.css b/browser/themes/pinstripe/devtools/webconsole.css
--- a/browser/themes/pinstripe/devtools/webconsole.css
+++ b/browser/themes/pinstripe/devtools/webconsole.css
@@ -249,16 +249,20 @@
 .webconsole-msg-console.webconsole-msg-warn {
   -moz-image-region: rect(24px, 24px, 32px, 16px);
 }
 
 .webconsole-msg-console.webconsole-msg-info {
   -moz-image-region: rect(24px, 32px, 32px, 24px);
 }
 
+.webconsole-mixed-content {
+  color: #FF0000;
+}
+
 /* Input and output styles */
 .webconsole-msg-input > .webconsole-msg-icon-container,
 .webconsole-msg-output > .webconsole-msg-icon-container {
   border-left: solid #808080 6px;
 }
 
 .webconsole-msg-input {
   -moz-image-region: rect(24px, 40px, 32px, 32px);
diff --git a/browser/themes/winstripe/devtools/webconsole.css b/browser/themes/winstripe/devtools/webconsole.css
--- a/browser/themes/winstripe/devtools/webconsole.css
+++ b/browser/themes/winstripe/devtools/webconsole.css
@@ -200,16 +200,20 @@
 .webconsole-msg-console.webconsole-msg-warn {
   -moz-image-region: rect(24px, 24px, 32px, 16px);
 }
 
 .webconsole-msg-console.webconsole-msg-info {
   -moz-image-region: rect(24px, 32px, 32px, 24px);
 }
 
+.webconsole-mixed-content {
+  color: #FF0000;
+}
+
 /* Input and output styles */
 .webconsole-msg-input > .webconsole-msg-icon-container,
 .webconsole-msg-output > .webconsole-msg-icon-container {
   border-left: solid #808080 6px;
 }
 
 .webconsole-msg-input {
   -moz-image-region: rect(24px, 40px, 32px, 32px);
