# HG changeset patch
# Parent aff6c68092f5ad73de26964b300b821826378497
# User Mihai Sucan <mihai.sucan@gmail.com>
# Date 1393882398 -7200

Bug 584733 - Code highlight all JS objects and functions in console output; r=bbenvie; try: -b do -p linux,linux64,macosx64,win32,win64 -u xpcshell,mochitest-bc,mochitest-o -t none

diff --git a/browser/devtools/shared/widgets/VariablesView.jsm b/browser/devtools/shared/widgets/VariablesView.jsm
--- a/browser/devtools/shared/widgets/VariablesView.jsm
+++ b/browser/devtools/shared/widgets/VariablesView.jsm
@@ -47,17 +47,17 @@ Object.defineProperty(this, "WebConsoleU
 Object.defineProperty(this, "NetworkHelper", {
   get: function() {
     return devtools.require("devtools/toolkit/webconsole/network-helper");
   },
   configurable: true,
   enumerable: true
 });
 
-this.EXPORTED_SYMBOLS = ["VariablesView"];
+this.EXPORTED_SYMBOLS = ["VariablesView", "escapeHTML"];
 
 /**
  * Debugger localization strings.
  */
 const STR = Services.strings.createBundle(DBG_STRINGS_URI);
 
 /**
  * A tree view for inspecting scopes, objects and properties.
@@ -3418,18 +3418,35 @@ VariablesView.stringifiers.byObjectClass
     }
 
     if (typeof preview.timestamp != "number") {
       return new Date(preview.timestamp).toString(); // invalid date
     }
 
     return "Date " + new Date(preview.timestamp).toISOString();
   },
+
+  String: function({displayString}) {
+    if (displayString === undefined) {
+      return null;
+    }
+    return VariablesView.getString(displayString);
+  },
+
+  Number: function({preview}) {
+    if (preview === undefined) {
+      return null;
+    }
+    return VariablesView.getString(preview.value);
+  },
 }; // VariablesView.stringifiers.byObjectClass
 
+VariablesView.stringifiers.byObjectClass.Boolean =
+  VariablesView.stringifiers.byObjectClass.Number;
+
 VariablesView.stringifiers.byObjectKind = {
   ArrayLike: function(aGrip, {concise}) {
     let {preview} = aGrip;
     if (concise) {
       return aGrip.class + "[" + preview.length + "]";
     }
 
     if (!preview.items) {
diff --git a/browser/devtools/webconsole/console-output.js b/browser/devtools/webconsole/console-output.js
--- a/browser/devtools/webconsole/console-output.js
+++ b/browser/devtools/webconsole/console-output.js
@@ -3,16 +3,17 @@
  * License, v. 2.0. If a copy of the MPL was not distributed with this
  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */
 
 "use strict";
 
 const {Cc, Ci, Cu} = require("chrome");
 
 loader.lazyImporter(this, "VariablesView", "resource:///modules/devtools/VariablesView.jsm");
+loader.lazyImporter(this, "escapeHTML", "resource:///modules/devtools/VariablesView.jsm");
 
 const Heritage = require("sdk/core/heritage");
 const XHTML_NS = "http://www.w3.org/1999/xhtml";
 const XUL_NS = "http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul";
 const STRINGS_URI = "chrome://browser/locale/devtools/webconsole.properties";
 
 const WebConsoleUtils = require("devtools/toolkit/webconsole/utils").Utils;
 const l10n = new WebConsoleUtils.l10n(STRINGS_URI);
@@ -997,43 +998,141 @@ Messages.Extended.prototype = Heritage.e
   {
     if (piece instanceof Ci.nsIDOMNode) {
       return piece;
     }
     if (typeof piece == "function") {
       return piece(this);
     }
 
-    let isPrimitive = VariablesView.isPrimitive({ value: piece });
-    let isActorGrip = WebConsoleUtils.isActorGrip(piece);
+    return this._renderValueGrip(piece);
+  },
+
+  /**
+   * Render a grip that represent a value received from the server. This method
+   * picks the appropriate widget to render the value with.
+   *
+   * @private
+   * @param object grip
+   *        The value grip received from the server.
+   * @param object options
+   *        Options for displaying the value. Available options:
+   *        - noStringQuotes - boolean that tells the renderer to not use quotes
+   *        around strings.
+   *        - concise - boolean that tells the renderer to compactly display the
+   *        grip. This is typically set to true when the object needs to be
+   *        displayed in an array preview, or as a property value in object
+   *        previews, etc.
+   * @return DOMElement
+   *         The DOM element that displays the given grip.
+   */
+  _renderValueGrip: function(grip, options = {})
+  {
+    let isPrimitive = VariablesView.isPrimitive({ value: grip });
+    let isActorGrip = WebConsoleUtils.isActorGrip(grip);
+    let noStringQuotes = !this._quoteStrings;
+    if ("noStringQuotes" in options) {
+      noStringQuotes = options.noStringQuotes;
+    }
 
     if (isActorGrip) {
-      this._repeatID.actors.add(piece.actor);
+      this._repeatID.actors.add(grip.actor);
 
       if (!isPrimitive) {
-        let widget = new Widgets.JSObject(this, piece).render();
-        return widget.element;
+        return this._renderObjectActor(grip, options);
       }
-      if (piece.type == "longString") {
-        let widget = new Widgets.LongString(this, piece).render();
+      if (grip.type == "longString") {
+        let widget = new Widgets.LongString(this, grip, options).render();
         return widget.element;
       }
     }
 
-    let result = this.document.createDocumentFragment();
+    let result = this.document.createElementNS(XHTML_NS, "span");
     if (isPrimitive) {
-      result.textContent = VariablesView.getString(piece, {
-        noStringQuotes: !this._quoteStrings,
+      let className = this.getClassNameForValueGrip(grip);
+      if (className) {
+        result.className = className;
+      }
+
+      result.textContent = VariablesView.getString(grip, {
+        noStringQuotes: noStringQuotes,
+        concise: options.concise,
       });
     } else {
-      result.textContent = piece;
+      result.textContent = grip;
     }
 
     return result;
   },
+
+  /**
+   * Get a CodeMirror-compatible class name for a given value grip.
+   *
+   * @param object grip
+   *        Value grip from the server.
+   * @return string
+   *         The class name for the grip.
+   */
+  getClassNameForValueGrip: function(grip)
+  {
+    let map = {
+      "number": "cm-number",
+      "longstring": "cm-string",
+      "string": "cm-string",
+      "regexp": "cm-string-2",
+      "boolean": "cm-atom",
+      "-infinity": "cm-atom",
+      "infinity": "cm-atom",
+      "null": "cm-atom",
+      "undefined": "cm-atom",
+    };
+
+    let className = map[typeof grip];
+    if (!className && grip && grip.type) {
+      className = map[grip.type.toLowerCase()];
+    }
+    if (!className && grip && grip.class) {
+      className = map[grip.class.toLowerCase()];
+    }
+
+    return className;
+  },
+
+  /**
+   * Display an object actor with the appropriate renderer.
+   *
+   * @private
+   * @param object objectActor
+   *        The ObjectActor to display.
+   * @param object options
+   *        Options to use for displaying the ObjectActor.
+   * @see this._renderValueGrip for the available options.
+   * @return DOMElement
+   *         The DOM element that displays the object actor.
+   */
+  _renderObjectActor: function(objectActor, options = {})
+  {
+    let widget = null;
+    let {preview} = objectActor;
+
+    if (preview && preview.kind) {
+      widget = Widgets.ObjectRenderers.byKind[preview.kind];
+    }
+
+    if (!widget || (widget.canRender && !widget.canRender(objectActor))) {
+      widget = Widgets.ObjectRenderers.byClass[objectActor.class];
+    }
+
+    if (!widget || (widget.canRender && !widget.canRender(objectActor))) {
+      widget = Widgets.JSObject;
+    }
+
+    let instance = new widget(this, objectActor, options).render();
+    return instance.element;
+  },
 }); // Messages.Extended.prototype
 
 
 
 /**
  * The JavaScriptEvalOutput message.
  *
  * @constructor
@@ -1051,16 +1150,17 @@ Messages.JavaScriptEvalOutput = function
     severity = "error";
     msg = errorMessage;
     quoteStrings = false;
   } else {
     msg = evalResponse.result;
   }
 
   let options = {
+    className: "cm-s-mozilla",
     timestamp: evalResponse.timestamp,
     category: "output",
     severity: severity,
     quoteStrings: quoteStrings,
   };
   Messages.Extended.call(this, [msg], options);
 };
 
@@ -1072,16 +1172,17 @@ Messages.JavaScriptEvalOutput.prototype 
  * @constructor
  * @extends Messages.Extended
  * @param object packet
  *        The Console API call packet received from the server.
  */
 Messages.ConsoleGeneric = function(packet)
 {
   let options = {
+    className: "cm-s-mozilla",
     timestamp: packet.timeStamp,
     category: "webdev",
     severity: CONSOLE_API_LEVELS_TO_SEVERITIES[packet.level],
     private: packet.private,
     filterDuplicates: true,
     location: {
       url: packet.filename,
       line: packet.lineNumber,
@@ -1288,16 +1389,48 @@ Widgets.BaseWidget.prototype = {
    * @return this
    */
   render: function() { },
 
   /**
    * Destroy this widget instance.
    */
   destroy: function() { },
+
+  el: function(tagNameIdAndClasses)
+  {
+    let attrs, text;
+    if (typeof arguments[1] == "object") {
+      attrs = arguments[1];
+      text = arguments[2];
+    } else {
+      text = arguments[1];
+    }
+
+    let tagName = tagNameIdAndClasses.split(/#|\./)[0];
+
+    let elem = this.document.createElementNS(XHTML_NS, tagName);
+    for (let name of Object.keys(attrs || {})) {
+      elem.setAttribute(name, attrs[name]);
+    }
+    if (text !== undefined && text !== null) {
+      elem.textContent = text;
+    }
+
+    let idAndClasses = tagNameIdAndClasses.match(/([#.][^#.]+)/g);
+    for (let idOrClass of (idAndClasses || [])) {
+      if (idOrClass.charAt(0) == "#") {
+        elem.id = idOrClass.substr(1);
+      } else {
+        elem.classList.add(idOrClass.substr(1));
+      }
+    }
+
+    return elem;
+  },
 };
 
 /**
  * The timestamp widget.
  *
  * @constructor
  * @param object message
  *        The owning message.
@@ -1329,68 +1462,745 @@ Widgets.MessageTimestamp.prototype = Her
     this.element.textContent = l10n.timestampString(this.timestamp) + " ";
 
     return this;
   },
 }); // Widgets.MessageTimestamp.prototype
 
 
 /**
- * The JavaScript object widget.
+ * Widget used for displaying ObjectActors that have no specialised renderers.
  *
  * @constructor
  * @param object message
  *        The owning message.
  * @param object objectActor
  *        The ObjectActor to display.
+ * @param object [options]
+ *        Options for displaying the given ObjectActor. See
+ *        Messages.Extended.prototype._renderValueGrip for the available
+ *        options.
  */
-Widgets.JSObject = function(message, objectActor)
+Widgets.JSObject = function(message, objectActor, options = {})
 {
   Widgets.BaseWidget.call(this, message);
   this.objectActor = objectActor;
+  this.options = options;
   this._onClick = this._onClick.bind(this);
 };
 
 Widgets.JSObject.prototype = Heritage.extend(Widgets.BaseWidget.prototype,
 {
   /**
    * The ObjectActor displayed by the widget.
    * @type object
    */
   objectActor: null,
 
   render: function()
   {
-    if (this.element) {
-      return this;
+    if (!this.element) {
+      this._render();
     }
 
-    let anchor = this.element = this.document.createElementNS(XHTML_NS, "a");
-    anchor.href = "#";
-    anchor.draggable = false;
-    anchor.textContent = VariablesView.getString(this.objectActor);
-    this.message._addLinkCallback(anchor, this._onClick);
+    return this;
+  },
 
-    return this;
+  _render: function()
+  {
+    let str = VariablesView.getString(this.objectActor, this.options);
+    let className = this.message.getClassNameForValueGrip(this.objectActor);
+    if (!className && this.objectActor.class == "Object") {
+      className = "cm-variable";
+    }
+
+    this.element = this._anchor(str, { className: className });
+  },
+
+  /**
+   * Render an anchor with a given text content and link.
+   *
+   * @private
+   * @param string text
+   *        Text to show in the anchor.
+   * @param object [options]
+   *        Available options:
+   *        - onClick (function): "click" event handler.By default a click on
+   *        the anchor opens the variables view for the current object actor
+   *        (this.objectActor).
+   *        - href (string): if given the string is used as a link, and clicks
+   *        on the anchor open the link in a new tab.
+   *        - appendTo (DOMElement): append the element to the given DOM
+   *        element. If not provided, the anchor is appended to |this.element|
+   *        if it is available. If |appendTo| is provided and if it is a falsy
+   *        value, the anchor is not appended to any element.
+   * @return DOMElement
+   *         The DOM element of the new anchor.
+   */
+  _anchor: function(text, options = {})
+  {
+    if (!options.onClick && !options.href) {
+      options.onClick = this._onClick;
+    }
+
+    let anchor = this.el("a", {
+      class: options.className,
+      draggable: false,
+      href: options.href || "#",
+    }, text);
+
+    this.message._addLinkCallback(anchor, !options.href ? options.onClick : null);
+
+    if (options.appendTo) {
+      options.appendTo.appendChild(anchor);
+    } else if (!("appendTo" in options) && this.element) {
+      this.element.appendChild(anchor);
+    }
+
+    return anchor;
   },
 
   /**
    * The click event handler for objects shown inline.
    * @private
    */
   _onClick: function()
   {
     this.output.openVariablesView({
       label: VariablesView.getString(this.objectActor, { concise: true }),
       objectActor: this.objectActor,
       autofocus: true,
     });
   },
+
+  /**
+   * Add a string to the message.
+   *
+   * @private
+   * @param string str
+   *        String to add.
+   * @param DOMElement [target = this.element]
+   *        Optional DOM element to append the string to. The default is
+   *        this.element.
+   */
+  _text: function(str, target = this.element)
+  {
+    target.appendChild(this.document.createTextNode(str));
+  },
 }); // Widgets.JSObject.prototype
 
+Widgets.ObjectRenderers = {};
+Widgets.ObjectRenderers.byKind = {};
+Widgets.ObjectRenderers.byClass = {};
+
+/**
+ * The widget used for displaying Date objects.
+ *
+ * @constructor
+ * @extends Widgets.JSObject
+ * @see Widget.JSObject for arguments
+ */
+Widgets.ObjectRenderers.byClass.Date = function(message, objectActor, options = {})
+{
+  Widgets.JSObject.call(this, message, objectActor, options);
+};
+
+Widgets.ObjectRenderers.byClass.Date.prototype = Heritage.extend(Widgets.JSObject.prototype,
+{
+  _render: function()
+  {
+    let {preview} = this.objectActor;
+    this.element = this.el("span.class-" + this.objectActor.class);
+
+    let anchorText = this.objectActor.class;
+    let anchorClass = "cm-variable";
+    if ("timestamp" in preview && typeof preview.timestamp != "number") {
+      anchorText = new Date(preview.timestamp).toString(); // invalid date
+      anchorClass = "";
+    }
+
+    this._anchor(anchorText, { className: anchorClass });
+
+    if (!("timestamp" in preview) || typeof preview.timestamp != "number") {
+      return this;
+    }
+
+    this._text(" ");
+
+    let elem = this.el("span.cm-string-2", new Date(preview.timestamp).toISOString());
+    this.element.appendChild(elem);
+  },
+}); // Widgets.ObjectRenderers.byClass.Date.prototype
+
+/**
+ * The widget used for displaying Function objects.
+ *
+ * @constructor
+ * @extends Widgets.JSObject
+ * @see Widget.JSObject for arguments
+ */
+Widgets.ObjectRenderers.byClass.Function = function(message, objectActor, options = {})
+{
+  Widgets.JSObject.call(this, message, objectActor, options);
+};
+
+Widgets.ObjectRenderers.byClass.Function.prototype = Heritage.extend(Widgets.JSObject.prototype,
+{
+  _render: function()
+  {
+    let grip = this.objectActor;
+    this.element = this.el("span.class-" + this.objectActor.class);
+
+    // TODO: Bug 948484 - support arrow functions and ES6 generators
+    let name = grip.userDisplayName || grip.displayName || grip.name || "";
+    name = VariablesView.getString(name, { noStringQuotes: true });
+
+    let str = this.options.concise ? name || "function " : "function " + name;
+
+    if (this.options.concise) {
+      this._anchor(name || "function", {
+        className: name ? "cm-variable" : "cm-keyword",
+      });
+      if (!name) {
+        this._text(" ");
+      }
+    } else if (name) {
+      this.element.appendChild(this.el("span.cm-keyword", "function"));
+      this._text(" ");
+      this._anchor(name, { className: "cm-variable" });
+    } else {
+      this._anchor("function", { className: "cm-keyword" });
+      this._text(" ");
+    }
+
+    this._text("(");
+
+    // TODO: Bug 948489 - Support functions with destructured parameters and
+    // rest parameters
+    let params = grip.parameterNames || [];
+    let shown = 0;
+    for (let param of params) {
+      if (shown > 0) {
+        this._text(", ");
+      }
+      this.element.appendChild(this.el("span.cm-def", param));
+      shown++;
+    }
+
+    this._text(")");
+  },
+}); // Widgets.ObjectRenderers.byClass.Function.prototype
+
+/**
+ * The widget used for displaying ArrayLike objects.
+ *
+ * @constructor
+ * @extends Widgets.JSObject
+ * @see Widget.JSObject for arguments
+ */
+Widgets.ObjectRenderers.byKind.ArrayLike = function(message, objectActor, options = {})
+{
+  Widgets.JSObject.call(this, message, objectActor, options);
+};
+
+Widgets.ObjectRenderers.byKind.ArrayLike.prototype = Heritage.extend(Widgets.JSObject.prototype,
+{
+  _render: function()
+  {
+    let {preview} = this.objectActor;
+    let {items} = preview;
+    this.element = this.el("span.kind-" + preview.kind);
+
+    this._anchor(this.objectActor.class, { className: "cm-variable" });
+
+    if (!items || this.options.concise) {
+      this._text("[");
+      this.element.appendChild(this.el("span.cm-number", preview.length));
+      this._text("]");
+      return this;
+    }
+
+    this._text(" [ ");
+
+    let shown = 0;
+    for (let item of items) {
+      if (shown > 0) {
+        this._text(", ");
+      }
+
+      if (item !== null) {
+        let elem = this.message._renderValueGrip(item, { concise: true });
+        this.element.appendChild(elem);
+      } else if (shown == (items.length - 1)) {
+        this._text(", ");
+      }
+
+      shown++;
+    }
+
+    if (shown < preview.length) {
+      this._text(", ");
+
+      let n = preview.length - shown;
+      let str = VariablesView.stringifiers._getNMoreString(n);
+      this._anchor(str);
+    }
+
+    this._text(" ]");
+  },
+}); // Widgets.ObjectRenderers.byKind.ArrayLike.prototype
+
+/**
+ * The widget used for displaying MapLike objects.
+ *
+ * @constructor
+ * @extends Widgets.JSObject
+ * @see Widget.JSObject for arguments
+ */
+Widgets.ObjectRenderers.byKind.MapLike = function(message, objectActor, options = {})
+{
+  Widgets.JSObject.call(this, message, objectActor, options);
+};
+
+Widgets.ObjectRenderers.byKind.MapLike.prototype = Heritage.extend(Widgets.JSObject.prototype,
+{
+  _render: function()
+  {
+    let {preview} = this.objectActor;
+    let {entries} = preview;
+
+    let container = this.element = this.el("span.kind-" + preview.kind);
+    this._anchor(this.objectActor.class, { className: "cm-variable" });
+
+    if (!entries || this.options.concise) {
+      if (typeof preview.size == "number") {
+        this._text("[");
+        container.appendChild(this.el("span.cm-number", preview.size));
+        this._text("]");
+      }
+      return;
+    }
+
+    this._text(" { ");
+
+    let shown = 0;
+    for (let [key, value] of entries) {
+      if (shown > 0) {
+        this._text(", ");
+      }
+
+      let keyElem = this.message._renderValueGrip(key, {
+        concise: true,
+        noStringQuotes: true,
+      });
+
+      // Strings are property names.
+      if (keyElem.classList && keyElem.classList.contains("cm-string")) {
+        keyElem.classList.remove("cm-string");
+        keyElem.classList.add("cm-property");
+      }
+
+      container.appendChild(keyElem);
+
+      this._text(": ");
+
+      let valueElem = this.message._renderValueGrip(value, { concise: true });
+      container.appendChild(valueElem);
+
+      shown++;
+    }
+
+    if (typeof preview.size == "number" && shown < preview.size) {
+      this._text(", ");
+
+      let n = preview.size - shown;
+      let str = VariablesView.stringifiers._getNMoreString(n);
+      this._anchor(str);
+    }
+
+    this._text(" }");
+  },
+}); // Widgets.ObjectRenderers.byKind.MapLike.prototype
+
+/**
+ * The widget used for displaying objects with a URL.
+ *
+ * @constructor
+ * @extends Widgets.JSObject
+ * @see Widget.JSObject for arguments
+ */
+Widgets.ObjectRenderers.byKind.ObjectWithURL = function(message, objectActor, options = {})
+{
+  Widgets.JSObject.call(this, message, objectActor, options);
+};
+
+Widgets.ObjectRenderers.byKind.ObjectWithURL.prototype = Heritage.extend(Widgets.JSObject.prototype,
+{
+  _render: function()
+  {
+    this.element = this._renderElement(this.objectActor,
+                                       this.objectActor.preview.url);
+  },
+
+  _renderElement: function(objectActor, url)
+  {
+    let container = this.el("span.kind-" + objectActor.preview.kind);
+
+    this._anchor(objectActor.class, {
+      className: "cm-variable",
+      appendTo: container,
+    });
+
+    if (!VariablesView.isFalsy({ value: url })) {
+      this._text(" \u2192 ", container);
+      let shortUrl = WebConsoleUtils.abbreviateSourceURL(url, {
+        onlyCropQuery: !this.options.concise
+      });
+      this._anchor(shortUrl, { href: url, appendTo: container });
+    }
+
+    return container;
+  },
+}); // Widgets.ObjectRenderers.byKind.ObjectWithURL.prototype
+
+/**
+ * The widget used for displaying objects with a string next to them.
+ *
+ * @constructor
+ * @extends Widgets.JSObject
+ * @see Widget.JSObject for arguments
+ */
+Widgets.ObjectRenderers.byKind.ObjectWithText = function(message, objectActor, options = {})
+{
+  Widgets.JSObject.call(this, message, objectActor, options);
+};
+
+Widgets.ObjectRenderers.byKind.ObjectWithText.prototype = Heritage.extend(Widgets.JSObject.prototype,
+{
+  _render: function()
+  {
+    let {preview} = this.objectActor;
+    this.element = this.el("span.kind-" + preview.kind);
+
+    this._anchor(this.objectActor.class, { className: "cm-variable" });
+
+    if (!this.options.concise) {
+      this._text(" ");
+      this.element.appendChild(this.el("span.cm-string",
+                                       VariablesView.getString(preview.text)));
+    }
+  },
+}); // Widgets.ObjectRenderers.byKind.ObjectWithText.prototype
+
+/**
+ * The widget used for displaying DOM event previews.
+ *
+ * @constructor
+ * @extends Widgets.JSObject
+ * @see Widget.JSObject for arguments
+ */
+Widgets.ObjectRenderers.byKind.DOMEvent = function(message, objectActor, options = {})
+{
+  Widgets.JSObject.call(this, message, objectActor, options);
+};
+
+Widgets.ObjectRenderers.byKind.DOMEvent.prototype = Heritage.extend(Widgets.JSObject.prototype,
+{
+  _render: function()
+  {
+    let {preview} = this.objectActor;
+
+    let container = this.element = this.el("span.kind-" + preview.kind);
+
+    this._anchor(preview.type || this.objectActor.class,
+                 { className: "cm-variable" });
+
+    if (this.options.concise) {
+      return;
+    }
+
+    if (preview.eventKind == "key" && preview.modifiers &&
+        preview.modifiers.length) {
+      this._text(" ");
+
+      let mods = 0;
+      for (let mod of preview.modifiers) {
+        if (mods > 0) {
+          this._text("-");
+        }
+        container.appendChild(this.el("span.cm-keyword", mod));
+        mods++;
+      }
+    }
+
+    this._text(" { ");
+
+    let shown = 0;
+    if (preview.target) {
+      container.appendChild(this.el("span.cm-property", "target"));
+      this._text(": ");
+      let target = this.message._renderValueGrip(preview.target, { concise: true });
+      container.appendChild(target);
+      shown++;
+    }
+
+    for (let key of Object.keys(preview.properties || {})) {
+      if (shown > 0) {
+        this._text(", ");
+      }
+
+      container.appendChild(this.el("span.cm-property", key));
+      this._text(": ");
+
+      let value = preview.properties[key];
+      let valueElem = this.message._renderValueGrip(value, { concise: true });
+      container.appendChild(valueElem);
+
+      shown++;
+    }
+
+    this._text(" }");
+  },
+}); // Widgets.ObjectRenderers.byKind.DOMEvent.prototype
+
+/**
+ * The widget used for displaying DOM node previews.
+ *
+ * @constructor
+ * @extends Widgets.JSObject
+ * @see Widget.JSObject for arguments
+ */
+Widgets.ObjectRenderers.byKind.DOMNode = function(message, objectActor, options = {})
+{
+  Widgets.JSObject.call(this, message, objectActor, options);
+};
+
+Widgets.ObjectRenderers.byKind.DOMNode.canRender = function(objectActor) {
+  let {preview} = objectActor;
+  if (!preview) {
+    return false;
+  }
+
+  switch (preview.nodeType) {
+    case Ci.nsIDOMNode.DOCUMENT_NODE:
+    case Ci.nsIDOMNode.ATTRIBUTE_NODE:
+    case Ci.nsIDOMNode.TEXT_NODE:
+    case Ci.nsIDOMNode.COMMENT_NODE:
+    case Ci.nsIDOMNode.DOCUMENT_FRAGMENT_NODE:
+      return true;
+    default:
+      return false;
+  }
+};
+
+Widgets.ObjectRenderers.byKind.DOMNode.prototype = Heritage.extend(Widgets.JSObject.prototype,
+{
+  _render: function()
+  {
+    switch (this.objectActor.preview.nodeType) {
+      case Ci.nsIDOMNode.DOCUMENT_NODE:
+        this._renderDocumentNode();
+        break;
+      case Ci.nsIDOMNode.ATTRIBUTE_NODE: {
+        let {preview} = this.objectActor;
+        this.element = this.el("span.attributeNode.kind-" + preview.kind);
+        let attr = this._renderAttributeNode(preview.nodeName, preview.value, true);
+        this.element.appendChild(attr);
+        break;
+      }
+      case Ci.nsIDOMNode.TEXT_NODE:
+        this._renderTextNode();
+        break;
+      case Ci.nsIDOMNode.COMMENT_NODE:
+        this._renderCommentNode();
+        break;
+      case Ci.nsIDOMNode.DOCUMENT_FRAGMENT_NODE:
+        this._renderDocumentFragmentNode();
+        break;
+      default:
+        throw new Error("Unsupported nodeType: " + preview.nodeType);
+    }
+  },
+
+  _renderDocumentNode: function()
+  {
+    let fn = Widgets.ObjectRenderers.byKind.ObjectWithURL.prototype._renderElement;
+    this.element = fn.call(this, this.objectActor,
+                           this.objectActor.preview.location);
+    this.element.classList.add("documentNode");
+  },
+
+  _renderAttributeNode: function(nodeName, nodeValue, addLink)
+  {
+    let value = VariablesView.getString(nodeValue, { noStringQuotes: true });
+
+    let fragment = this.document.createDocumentFragment();
+    if (addLink) {
+      this._anchor(nodeName, { className: "cm-attribute", appendTo: fragment });
+    } else {
+      fragment.appendChild(this.el("span.cm-attribute", nodeName));
+    }
+
+    this._text("=", fragment);
+    fragment.appendChild(this.el("span.cm-string", '"' + escapeHTML(value) + '"'));
+
+    return fragment;
+  },
+
+  _renderTextNode: function()
+  {
+    let {preview} = this.objectActor;
+    this.element = this.el("span.textNode.kind-" + preview.kind);
+
+    this._anchor(preview.nodeName, { className: "cm-variable" });
+    this._text(" ");
+
+    let text = VariablesView.getString(preview.textContent);
+    this.element.appendChild(this.el("span.cm-string", text));
+  },
+
+  _renderCommentNode: function()
+  {
+    let {preview} = this.objectActor;
+    let comment = "<!-- " + VariablesView.getString(preview.textContent, {
+      noStringQuotes: true,
+    }) + " -->";
+
+    this.element = this._anchor(comment, {
+      className: "kind-" + preview.kind + " commentNode cm-comment",
+    });
+  },
+
+  _renderDocumentFragmentNode: function()
+  {
+    let {preview} = this.objectActor;
+    let {childNodes} = preview;
+    let container = this.element = this.el("span.documentFragmentNode.kind-" +
+                                           preview.kind);
+
+    this._anchor(this.objectActor.class, { className: "cm-variable" });
+
+    if (!childNodes || this.options.concise) {
+      this._text("[");
+      container.appendChild(this.el("span.cm-number", preview.childNodesLength));
+      this._text("]");
+      return;
+    }
+
+    this._text(" [ ");
+
+    let shown = 0;
+    for (let item of childNodes) {
+      if (shown > 0) {
+        this._text(", ");
+      }
+
+      let elem = this.message._renderValueGrip(item, { concise: true });
+      container.appendChild(elem);
+      shown++;
+    }
+
+    if (shown < preview.childNodesLength) {
+      this._text(", ");
+
+      let n = preview.childNodesLength - shown;
+      let str = VariablesView.stringifiers._getNMoreString(n);
+      this._anchor(str);
+    }
+
+    this._text(" ]");
+  },
+}); // Widgets.ObjectRenderers.byKind.DOMNode.prototype
+
+/**
+ * The widget used for displaying generic JS object previews.
+ *
+ * @constructor
+ * @extends Widgets.JSObject
+ * @see Widget.JSObject for arguments
+ */
+Widgets.ObjectRenderers.byKind.Object = function(message, objectActor, options = {})
+{
+  Widgets.JSObject.call(this, message, objectActor, options);
+};
+
+Widgets.ObjectRenderers.byKind.Object.prototype = Heritage.extend(Widgets.JSObject.prototype,
+{
+  _render: function()
+  {
+    let {preview} = this.objectActor;
+    let {ownProperties, safeGetterValues} = preview;
+
+    if ((!ownProperties && !safeGetterValues) || this.options.concise) {
+      this.element = this._anchor(this.objectActor.class,
+                                  { className: "cm-variable" });
+      return;
+    }
+
+    let container = this.element = this.el("span.kind-" + preview.kind);
+    this._anchor(this.objectActor.class, { className: "cm-variable" });
+    this._text(" { ");
+
+    let addProperty = (str) => {
+      container.appendChild(this.el("span.cm-property", str));
+    };
+
+    let shown = 0;
+    for (let key of Object.keys(ownProperties || {})) {
+      if (shown > 0) {
+        this._text(", ");
+      }
+
+      let value = ownProperties[key];
+
+      addProperty(key);
+      this._text(": ");
+
+      if (value.get) {
+        addProperty("Getter");
+      } else if (value.set) {
+        addProperty("Setter");
+      } else {
+        let valueElem = this.message._renderValueGrip(value.value, { concise: true });
+        container.appendChild(valueElem);
+      }
+
+      shown++;
+    }
+
+    let ownPropertiesShown = shown;
+
+    for (let key of Object.keys(safeGetterValues || {})) {
+      if (shown > 0) {
+        this._text(", ");
+      }
+
+      addProperty(key);
+      this._text(": ");
+
+      let value = safeGetterValues[key].getterValue;
+      let valueElem = this.message._renderValueGrip(value, { concise: true });
+      container.appendChild(valueElem);
+
+      shown++;
+    }
+
+    if (typeof preview.ownPropertiesLength == "number" &&
+        ownPropertiesShown < preview.ownPropertiesLength) {
+      this._text(", ");
+
+      let n = preview.ownPropertiesLength - ownPropertiesShown;
+      let str = VariablesView.stringifiers._getNMoreString(n);
+      this._anchor(str);
+    }
+
+    this._text(" }");
+  },
+}); // Widgets.ObjectRenderers.byKind.Object.prototype
+
 /**
  * The long string widget.
  *
  * @constructor
  * @param object message
  *        The owning message.
  * @param object longStringActor
  *        The LongStringActor to display.
@@ -1413,17 +2223,17 @@ Widgets.LongString.prototype = Heritage.
 
   render: function()
   {
     if (this.element) {
       return this;
     }
 
     let result = this.element = this.document.createElementNS(XHTML_NS, "span");
-    result.className = "longString";
+    result.className = "longString cm-string";
     this._renderString(this.longStringActor.initial);
     result.appendChild(this._renderEllipsis());
 
     return this;
   },
 
   /**
    * Render the long string in the widget element.
diff --git a/browser/devtools/webconsole/test/browser_bug_865871_variables_view_close_on_esc_key.js b/browser/devtools/webconsole/test/browser_bug_865871_variables_view_close_on_esc_key.js
--- a/browser/devtools/webconsole/test/browser_bug_865871_variables_view_close_on_esc_key.js
+++ b/browser/devtools/webconsole/test/browser_bug_865871_variables_view_close_on_esc_key.js
@@ -18,19 +18,20 @@ function test()
     let {tab} = yield loadTab(TEST_URI);
     hud = yield openConsole(tab);
     let jsterm = hud.jsterm;
 
     let msg = yield execute("fooObj");
     ok(msg, "output message found");
 
     let anchor = msg.querySelector("a");
+    let body = msg.querySelector(".body");
     ok(anchor, "object anchor");
-    isnot(anchor.textContent.indexOf('testProp: "testValue"'), -1,
-          "message text check");
+    ok(body, "message body");
+    ok(body.textContent.contains('testProp: "testValue"'), "message text check");
 
     msg.scrollIntoView();
     executeSoon(() => {
       EventUtils.synthesizeMouse(anchor, 2, 2, {}, hud.iframeWindow);
     });
 
     let vviewVar = yield jsterm.once("variablesview-fetched");
     let vview = vviewVar._variablesView;
@@ -53,20 +54,22 @@ function test()
     });
     yield jsterm.once("sidebar-closed");
 
     jsterm.clearOutput();
 
     msg = yield execute("window");
     ok(msg, "output message found");
 
-    let anchor = msg.querySelector("a");
+    body = msg.querySelector(".body");
+    ok(body, "message body");
+    anchor = msg.querySelector("a");
     ok(anchor, "object anchor");
-    isnot(anchor.textContent.indexOf("Window \u2192 http://example.com/browser/"), -1,
-          "message text check");
+    ok(body.textContent.contains("Window \u2192 http://example.com/browser/"),
+       "message text check");
 
     msg.scrollIntoView();
     executeSoon(() => {
       EventUtils.synthesizeMouse(anchor, 2, 2, {}, hud.iframeWindow)
     });
     vviewVar = yield jsterm.once("variablesview-fetched");
 
     vview = vviewVar._variablesView;
diff --git a/browser/devtools/webconsole/test/browser_bug_869003_inspect_cross_domain_object.js b/browser/devtools/webconsole/test/browser_bug_869003_inspect_cross_domain_object.js
--- a/browser/devtools/webconsole/test/browser_bug_869003_inspect_cross_domain_object.js
+++ b/browser/devtools/webconsole/test/browser_bug_869003_inspect_cross_domain_object.js
@@ -39,20 +39,25 @@ function consoleOpened(hud)
       severity: SEVERITY_LOG,
       objects: true,
     }],
   }).then(onConsoleMessage);
 }
 
 function onConsoleMessage(aResults)
 {
+  let msg = [...aResults[0].matched][0];
+  ok(msg, "message element");
+
+  let body = msg.querySelector(".body");
+  ok(body, "message body");
+
   let clickable = aResults[0].clickableElements[0];
   ok(clickable, "clickable object found");
-  isnot(clickable.textContent.indexOf('{hello: "world!",'), -1,
-        "message text check");
+  ok(body.textContent.contains('{ hello: "world!",'), "message text check");
 
   gJSTerm.once("variablesview-fetched", onObjFetch);
 
   EventUtils.synthesizeMouse(clickable, 2, 2, {}, gWebConsole.iframeWindow)
 }
 
 function onObjFetch(aEvent, aVar)
 {
diff --git a/browser/devtools/webconsole/test/browser_console_consolejsm_output.js b/browser/devtools/webconsole/test/browser_console_consolejsm_output.js
--- a/browser/devtools/webconsole/test/browser_console_consolejsm_output.js
+++ b/browser/devtools/webconsole/test/browser_console_consolejsm_output.js
@@ -66,17 +66,17 @@ function test()
         {
           name: "console.warn output",
           text: "bug851231-warn",
           category: CATEGORY_WEBDEV,
           severity: SEVERITY_WARNING,
         },
         {
           name: "console.error output",
-          text: /\bbug851231-error\b.+\{bug851231prop:\s"bug851231value"\}/,
+          text: /\bbug851231-error\b.+\{\s*bug851231prop:\s"bug851231value"\s*\}/,
           category: CATEGORY_WEBDEV,
           severity: SEVERITY_ERROR,
           objects: true,
         },
         {
           name: "console.debug output",
           text: "bug851231-debug",
           category: CATEGORY_WEBDEV,
@@ -86,17 +86,17 @@ function test()
           name: "console.trace output",
           consoleTrace: {
             file: "browser_console_consolejsm_output.js",
             fn: "onCachedMessage",
           },
         },
         {
           name: "console.dir output",
-          consoleDir: /XULDocument .+ chrome:\/\/.+\/browser\.xul/,
+          consoleDir: /XULDocument\s+.+\s+chrome:\/\/.+\/browser\.xul/,
         },
         {
           name: "console.time output",
           consoleTime: "foobarTimer",
         },
         {
           name: "console.timeEnd output",
           consoleTimeEnd: "foobarTimer",
diff --git a/browser/devtools/webconsole/test/browser_console_hide_jsterm_when_devtools_chrome_enabled_false.js b/browser/devtools/webconsole/test/browser_console_hide_jsterm_when_devtools_chrome_enabled_false.js
--- a/browser/devtools/webconsole/test/browser_console_hide_jsterm_when_devtools_chrome_enabled_false.js
+++ b/browser/devtools/webconsole/test/browser_console_hide_jsterm_when_devtools_chrome_enabled_false.js
@@ -31,17 +31,18 @@ function* getVariablesView(hud) {
 
   let deferred = promise.defer();
   hud.jsterm.clearOutput();
   hud.jsterm.execute('new Object()');
 
   let [message] = yield waitForMessages({
     webconsole: hud,
     messages: [{
-      text: "object"
+      text: "Object",
+      category: CATEGORY_OUTPUT,
     }],
   })
 
   hud.jsterm.once("variablesview-fetched", openVariablesView);
 
   let anchor = [...message.matched][0].querySelector("a");
 
   executeSoon(() =>
diff --git a/browser/devtools/webconsole/test/browser_console_log_inspectable_object.js b/browser/devtools/webconsole/test/browser_console_log_inspectable_object.js
--- a/browser/devtools/webconsole/test/browser_console_log_inspectable_object.js
+++ b/browser/devtools/webconsole/test/browser_console_log_inspectable_object.js
@@ -27,20 +27,24 @@ function performTest(hud)
     webconsole: hud,
     messages: [{
       text: "fooBug676722",
       category: CATEGORY_WEBDEV,
       severity: SEVERITY_LOG,
       objects: true,
     }],
   }).then(([result]) => {
+    let msg = [...result.matched][0];
+    ok(msg, "message element");
+    let body = msg.querySelector(".body");
+    ok(body, "message body");
     let clickable = result.clickableElements[0];
     ok(clickable, "the console.log() object anchor was found");
-    isnot(clickable.textContent.indexOf('{abba: "omgBug676722"}'), -1,
-          "clickable node content is correct");
+    ok(body.textContent.contains('{ abba: "omgBug676722" }'),
+       "clickable node content is correct");
 
     hud.jsterm.once("variablesview-fetched",
       (aEvent, aVar) => {
         ok(aVar, "object inspector opened on click");
 
         findVariableViewProperties(aVar, [{
           name: "abba",
           value: "omgBug676722",
diff --git a/browser/devtools/webconsole/test/browser_console_variables_view.js b/browser/devtools/webconsole/test/browser_console_variables_view.js
--- a/browser/devtools/webconsole/test/browser_console_variables_view.js
+++ b/browser/devtools/webconsole/test/browser_console_variables_view.js
@@ -23,18 +23,17 @@ function consoleOpened(hud)
   gWebConsole = hud;
   gJSTerm = hud.jsterm;
   gJSTerm.execute("fooObj", onExecuteFooObj);
 }
 
 function onExecuteFooObj(msg)
 {
   ok(msg, "output message found");
-  isnot(msg.textContent.indexOf('{testProp: "testValue"}'), -1,
-        "message text check");
+  ok(msg.textContent.contains('{ testProp: "testValue" }'), "message text check");
 
   let anchor = msg.querySelector("a");
   ok(anchor, "object link found");
 
   gJSTerm.once("variablesview-fetched", onFooObjFetch);
 
   executeSoon(() =>
     EventUtils.synthesizeMouse(anchor, 2, 2, {}, gWebConsole.iframeWindow)
diff --git a/browser/devtools/webconsole/test/browser_console_variables_view_while_debugging.js b/browser/devtools/webconsole/test/browser_console_variables_view_while_debugging.js
--- a/browser/devtools/webconsole/test/browser_console_variables_view_while_debugging.js
+++ b/browser/devtools/webconsole/test/browser_console_variables_view_while_debugging.js
@@ -57,18 +57,17 @@ function onFramesAdded()
     )
   );
 }
 
 
 function onExecuteFooObj(msg)
 {
   ok(msg, "output message found");
-  isnot(msg.textContent.indexOf('{testProp2: "testValue2"}'), -1,
-        "message text check");
+  ok(msg.textContent.contains('{ testProp2: "testValue2" }'), "message text check");
 
   let anchor = msg.querySelector("a");
   ok(anchor, "object link found");
 
   gJSTerm.once("variablesview-fetched", onFooObjFetch);
 
   executeSoon(() => EventUtils.synthesizeMouse(anchor, 2, 2, {},
                                                gWebConsole.iframeWindow));
diff --git a/browser/devtools/webconsole/test/browser_console_variables_view_while_debugging_and_inspecting.js b/browser/devtools/webconsole/test/browser_console_variables_view_while_debugging_and_inspecting.js
--- a/browser/devtools/webconsole/test/browser_console_variables_view_while_debugging_and_inspecting.js
+++ b/browser/devtools/webconsole/test/browser_console_variables_view_while_debugging_and_inspecting.js
@@ -52,18 +52,18 @@ function onFramesAdded()
   info("onFramesAdded");
 
   openConsole(null, () => gJSTerm.execute("fooObj", onExecuteFooObj));
 }
 
 function onExecuteFooObj(msg)
 {
   ok(msg, "output message found");
-  isnot(msg.textContent.indexOf('{testProp2: "testValue2"}'), -1,
-        "message text check");
+  ok(msg.textContent.contains('{ testProp2: "testValue2" }'),
+     "message text check");
 
   let anchor = msg.querySelector("a");
   ok(anchor, "object link found");
 
   gJSTerm.once("variablesview-fetched", onFooObjFetch);
 
   EventUtils.synthesizeMouse(anchor, 2, 2, {}, gWebConsole.iframeWindow);
 }
diff --git a/browser/devtools/webconsole/test/browser_webconsole_output_02.js b/browser/devtools/webconsole/test/browser_webconsole_output_02.js
--- a/browser/devtools/webconsole/test/browser_webconsole_output_02.js
+++ b/browser/devtools/webconsole/test/browser_webconsole_output_02.js
@@ -50,104 +50,104 @@ let inputTests = [
     printOutput: "function testfn3() { return 42; }",
     inspectable: true,
     variablesViewLabel: "testfn3DisplayName()",
   },
 
   // 5 - basic array
   {
     input: "window.array1",
-    output: '[1, 2, 3, "a", "b", "c", "4", "5"]',
+    output: 'Array [ 1, 2, 3, "a", "b", "c", "4", "5" ]',
     printOutput: "1,2,3,a,b,c,4,5",
     inspectable: true,
     variablesViewLabel: "Array[8]",
   },
 
   // 6 - array with objects
   {
     input: "window.array2",
-    output: '["a", HTMLDocument \u2192 test-console-output-02.html, <body>, ' +
-            "DOMStringMap[0], DOMTokenList[0]]",
+    output: 'Array [ "a", HTMLDocument \u2192 test-console-output-02.html, <body>, ' +
+            "DOMStringMap[0], DOMTokenList[0] ]",
     printOutput: '"a,[object HTMLDocument],[object HTMLBodyElement],' +
                  '[object DOMStringMap],"',
     inspectable: true,
     variablesViewLabel: "Array[5]",
   },
 
   // 7 - array with more than 10 elements
   {
     input: "window.array3",
-    output: '[1, Window \u2192 test-console-output-02.html, null, "a", "b", ' +
-            'undefined, false, "", -Infinity, testfn3DisplayName(), 3 more\u2026]',
+    output: 'Array [ 1, Window \u2192 test-console-output-02.html, null, "a", "b", ' +
+            'undefined, false, "", -Infinity, testfn3DisplayName(), 3 more\u2026 ]',
     printOutput: '"1,[object Window],,a,b,,false,,-Infinity,' +
                  'function testfn3() { return 42; },[object Object],foo,bar"',
     inspectable: true,
     variablesViewLabel: "Array[13]",
   },
 
   // 8 - array with holes and a cyclic reference
   {
     input: "window.array4",
-    output: '[,,,,, "test", Array[7]]',
+    output: 'Array [ , , , , , "test", Array[7] ]',
     printOutput: '",,,,,test,"',
     inspectable: true,
     variablesViewLabel: "Array[7]",
   },
 
   // 9
   {
     input: "window.typedarray1",
-    output: 'Int32Array [1, 287, 8651, 40983, 8754]',
+    output: 'Int32Array [ 1, 287, 8651, 40983, 8754 ]',
     printOutput: "[object Int32Array]",
     inspectable: true,
     variablesViewLabel: "Int32Array[5]",
   },
 
   // 10 - Set with cyclic reference
   {
     input: "window.set1",
-    output: 'Set [1, 2, null, Array[13], "a", "b", undefined, <head>, Set[9]]',
+    output: 'Set [ 1, 2, null, Array[13], "a", "b", undefined, <head>, Set[9] ]',
     printOutput: "[object Set]",
     inspectable: true,
     variablesViewLabel: "Set[9]",
   },
 
   // 11 - Object with cyclic reference and a getter
   {
     input: "window.testobj2",
-    output: '{a: "b", c: "d", e: 1, f: "2", foo: Object, bar: Object, ' +
-            "getterTest: Getter}",
+    output: 'Object { a: "b", c: "d", e: 1, f: "2", foo: Object, bar: Object, ' +
+            "getterTest: Getter }",
     printOutput: "[object Object]",
     inspectable: true,
     variablesViewLabel: "Object",
   },
 
   // 12 - Object with more than 10 properties
   {
     input: "window.testobj3",
-    output: '{a: "b", c: "d", e: 1, f: "2", g: true, h: null, i: undefined, ' +
-            'j: "", k: StyleSheetList[0], l: NodeList[5], 2 more\u2026}',
+    output: 'Object { a: "b", c: "d", e: 1, f: "2", g: true, h: null, i: undefined, ' +
+            'j: "", k: StyleSheetList[0], l: NodeList[5], 2 more\u2026 }',
     printOutput: "[object Object]",
     inspectable: true,
     variablesViewLabel: "Object",
   },
 
   // 13 - Object with a non-enumerable property that we do not show
   {
     input: "window.testobj4",
-    output: '{a: "b", c: "d", 1 more\u2026}',
+    output: 'Object { a: "b", c: "d", 1 more\u2026 }',
     printOutput: "[object Object]",
     inspectable: true,
     variablesViewLabel: "Object",
   },
 
   // 14 - Map with cyclic references
   {
     input: "window.map1",
-    output: 'Map {a: "b", HTMLCollection[2]: Object, Map[3]: Set[9]}',
+    output: 'Map { a: "b", HTMLCollection[2]: Object, Map[3]: Set[9] }',
     printOutput: "[object Map]",
     inspectable: true,
     variablesViewLabel: "Map[3]",
   },
 ];
 
 function test() {
 
diff --git a/browser/devtools/webconsole/test/browser_webconsole_output_03.js b/browser/devtools/webconsole/test/browser_webconsole_output_03.js
--- a/browser/devtools/webconsole/test/browser_webconsole_output_03.js
+++ b/browser/devtools/webconsole/test/browser_webconsole_output_03.js
@@ -33,26 +33,26 @@ let inputTests = [
     printOutput: "[object HTMLBodyElement]",
     inspectable: true,
     noClick: true,
   },
 
   // 3
   {
     input: "document.body.dataset",
-    output: "DOMStringMap {}",
+    output: "DOMStringMap {  }",
     printOutput: "[object DOMStringMap]",
     inspectable: true,
     variablesViewLabel: "DOMStringMap[0]",
   },
 
   // 4
   {
     input: "document.body.classList",
-    output: "DOMTokenList []",
+    output: "DOMTokenList [  ]",
     printOutput: '""',
     inspectable: true,
     variablesViewLabel: "DOMTokenList[0]",
   },
 
   // 5
   {
     input: "window.location.href",
@@ -66,26 +66,26 @@ let inputTests = [
     printOutput: TEST_URI,
     inspectable: true,
     variablesViewLabel: "Location \u2192 test-console-output-03.html",
   },
 
   // 7
   {
     input: "document.body.attributes",
-    output: "MozNamedAttrMap []",
+    output: "MozNamedAttrMap [  ]",
     printOutput: "[object MozNamedAttrMap]",
     inspectable: true,
     variablesViewLabel: "MozNamedAttrMap[0]",
   },
 
   // 8
   {
     input: "document.styleSheets",
-    output: "StyleSheetList []",
+    output: "StyleSheetList [  ]",
     printOutput: "[object StyleSheetList",
     inspectable: true,
     variablesViewLabel: "StyleSheetList[0]",
   },
 
   // 9
   {
     input: "testBodyClassName()",
@@ -102,17 +102,17 @@ let inputTests = [
     printOutput: "[object HTMLBodyElement]",
     inspectable: true,
     noClick: true,
   },
 
   // 11
   {
     input: "document.body.classList",
-    output: 'DOMTokenList ["test1", "tezt2"]',
+    output: 'DOMTokenList [ "test1", "tezt2" ]',
     printOutput: '"test1 tezt2"',
     inspectable: true,
     variablesViewLabel: "DOMTokenList[2]",
   },
 
   // 12
   {
     input: "testBodyDataset()",
@@ -121,27 +121,27 @@ let inputTests = [
     printOutput: "[object HTMLBodyElement]",
     inspectable: true,
     noClick: true,
   },
 
   // 13
   {
     input: "document.body.dataset",
-    output: 'DOMStringMap {preview: "zuzu"<a>foo"}',
+    output: 'DOMStringMap { preview: "zuzu"<a>foo" }',
     printOutput: "[object DOMStringMap]",
     inspectable: true,
     variablesViewLabel: "DOMStringMap[1]",
   },
 
   // 14
   {
     input: "document.body.attributes",
-    output: 'MozNamedAttrMap [class="test1 tezt2", id="foobarid", ' +
-            'data-preview="zuzu&quot;&lt;a&gt;foo"]',
+    output: 'MozNamedAttrMap [ class="test1 tezt2", id="foobarid", ' +
+            'data-preview="zuzu&quot;&lt;a&gt;foo" ]',
     printOutput: "[object MozNamedAttrMap]",
     inspectable: true,
     variablesViewLabel: "MozNamedAttrMap[3]",
   },
 
   // 15
   {
     input: "document.body.attributes[0]",
diff --git a/browser/devtools/webconsole/test/browser_webconsole_output_04.js b/browser/devtools/webconsole/test/browser_webconsole_output_04.js
--- a/browser/devtools/webconsole/test/browser_webconsole_output_04.js
+++ b/browser/devtools/webconsole/test/browser_webconsole_output_04.js
@@ -15,26 +15,26 @@ let inputTests = [
     printOutput: "[object Text]",
     inspectable: true,
     noClick: true,
   },
 
   // 1
   {
     input: "testCommentNode()",
-    output: "<!--\n  - Any copyright ",
+    output: /<!--\s+- Any copyright /,
     printOutput: "[object Comment]",
     inspectable: true,
     noClick: true,
   },
 
   // 2
   {
     input: "testDocumentFragment()",
-    output: 'DocumentFragment [<div id="foo1" class="bar">, <div id="foo3">]',
+    output: 'DocumentFragment [ <div#foo1>, <div#foo3> ]',
     printOutput: "[object DocumentFragment]",
     inspectable: true,
     variablesViewLabel: "DocumentFragment[2]",
   },
 
   // 3
   {
     input: "testError()",
@@ -53,43 +53,43 @@ let inputTests = [
     printOutput: '[Exception... "An invalid or illegal string was specified"',
     inspectable: true,
     variablesViewLabel: "SyntaxError",
   },
 
   // 5
   {
     input: "testCSSStyleDeclaration()",
-    output: 'CSS2Properties {color: "green", font-size: "2em"}',
+    output: 'CSS2Properties { color: "green", font-size: "2em" }',
     printOutput: "[object CSS2Properties]",
     inspectable: true,
     noClick: true,
   },
 
   // 6
   {
     input: "testStyleSheetList()",
-    output: "StyleSheetList [CSSStyleSheet]",
+    output: "StyleSheetList [ CSSStyleSheet ]",
     printOutput: "[object StyleSheetList",
     inspectable: true,
     variablesViewLabel: "StyleSheetList[1]",
   },
 
   // 7
   {
     input: "document.styleSheets[0]",
     output: "CSSStyleSheet",
     printOutput: "[object CSSStyleSheet]",
     inspectable: true,
   },
 
   // 8
   {
     input: "document.styleSheets[0].cssRules",
-    output: "CSSRuleList [CSSStyleRule, CSSMediaRule]",
+    output: "CSSRuleList [ CSSStyleRule, CSSMediaRule ]",
     printOutput: "[object CSSRuleList",
     inspectable: true,
     variablesViewLabel: "CSSRuleList[2]",
   },
 
   // 9
   {
     input: "document.styleSheets[0].cssRules[0]",
diff --git a/browser/devtools/webconsole/test/browser_webconsole_output_events.js b/browser/devtools/webconsole/test/browser_webconsole_output_events.js
--- a/browser/devtools/webconsole/test/browser_webconsole_output_events.js
+++ b/browser/devtools/webconsole/test/browser_webconsole_output_events.js
@@ -31,30 +31,30 @@ function test() {
     });
 
     EventUtils.synthesizeMouse(content.document.body, 2, 2, {type: "mousemove"}, content);
 
     yield waitForMessages({
       webconsole: hud,
       messages: [{
         name: "console.log() output for mousemove",
-        text: /"eventLogger" mousemove {target: .+, buttons: 1, clientX: \d+, clientY: \d+, layerX: \d+, layerY: \d+}/,
+        text: /"eventLogger" mousemove { target: .+, buttons: 1, clientX: \d+, clientY: \d+, layerX: \d+, layerY: \d+ }/,
         category: CATEGORY_WEBDEV,
         severity: SEVERITY_LOG,
       }],
     });
 
     content.focus();
     EventUtils.synthesizeKey("a", {shiftKey: true}, content);
 
     yield waitForMessages({
       webconsole: hud,
       messages: [{
         name: "console.log() output for keypress",
-        text: /"eventLogger" keypress Shift {target: .+, key: .+, charCode: \d+, keyCode: \d+}/,
+        text: /"eventLogger" keypress Shift { target: .+, key: .+, charCode: \d+, keyCode: \d+ }/,
         category: CATEGORY_WEBDEV,
         severity: SEVERITY_LOG,
       }],
     });
 
     finishTest();
   }
 }
diff --git a/browser/devtools/webconsole/webconsole.js b/browser/devtools/webconsole/webconsole.js
--- a/browser/devtools/webconsole/webconsole.js
+++ b/browser/devtools/webconsole/webconsole.js
@@ -2135,23 +2135,18 @@ WebConsoleFrame.prototype = {
     }
 
     // If the queue is not empty, schedule another flush.
     if (this._outputQueue.length > 0) {
       this._initOutputTimer();
     }
     else {
       this._outputTimerInitialized = false;
-      if (this._flushCallback) {
-        try {
-          this._flushCallback();
-        }
-        catch (ex) {
-          console.error(ex);
-        }
+      if (this._flushCallback && this._flushCallback() === false) {
+        this._flushCallback = null;
       }
     }
 
     this._lastOutputFlush = Date.now();
   },
 
   /**
    * Initialize the output timer.
@@ -3199,20 +3194,20 @@ JSTerm.prototype = {
 
     if (aCallback) {
       let oldFlushCallback = this.hud._flushCallback;
       this.hud._flushCallback = () => {
         aCallback(msg.element);
         if (oldFlushCallback) {
           oldFlushCallback();
           this.hud._flushCallback = oldFlushCallback;
+          return true;
         }
-        else {
-          this.hud._flushCallback = null;
-        }
+
+        return false;
       };
     }
 
     msg._afterMessage = aAfterMessage;
     msg._objectActors = new Set();
 
     if (WebConsoleUtils.isActorGrip(aResponse.exception)) {
       msg._objectActors.add(aResponse.exception.actor);
diff --git a/browser/themes/shared/devtools/webconsole.inc.css b/browser/themes/shared/devtools/webconsole.inc.css
--- a/browser/themes/shared/devtools/webconsole.inc.css
+++ b/browser/themes/shared/devtools/webconsole.inc.css
@@ -184,17 +184,17 @@ a {
   -moz-margin-start: 6px;
 }
 
 .message[category=network].mixed-content .url {
   color: #FF0000;
 }
 
 .message .learn-more-link {
-  color: #0000EE;
+  color: -moz-nativehyperlinktext;
   margin: 0 6px;
 }
 
 /* CSS styles */
 .webconsole-filter-button[category="css"] > .toolbarbutton-menubutton-button:before {
   background-image: linear-gradient(#2DC3F3, #00B6F0);
   border-color: #1BA2CC;
 }
@@ -366,16 +366,26 @@ a {
   margin: 0;
 }
 
 .stacktrace .function {
   display: block;
   flex: 1 1 auto;
 }
 
+.cm-s-mozilla a[class] {
+  font-style: italic;
+  text-decoration: none;
+}
+
+.cm-s-mozilla a[class]:hover,
+.cm-s-mozilla a[class]:focus {
+  text-decoration: underline;
+}
+
 /* Replace these values with CSS variables as available */
 .theme-dark .jsterm-input-container {
   background-color: #252c33; /* tabToolbarBackgroundColor */
   border-color: #131c26; /* mainBackgroundColor */
 }
 
 .theme-dark .jsterm-input-node {
   color: #8fa1b2; /* textColor */
diff --git a/toolkit/devtools/server/actors/script.js b/toolkit/devtools/server/actors/script.js
--- a/toolkit/devtools/server/actors/script.js
+++ b/toolkit/devtools/server/actors/script.js
@@ -3303,16 +3303,88 @@ ObjectActor.prototype.requestTypes = {
  *   - the raw JS object after calling Debugger.Object.unsafeDereference(). This
  *   argument is only provided if the object is safe for reading properties and
  *   executing methods. See DevToolsUtils.isSafeJSObject().
  *
  * Functions must return false if they cannot provide preview
  * information for the debugger object, or true otherwise.
  */
 DebuggerServer.ObjectActorPreviewers = {
+  String: [function({obj, threadActor}, aGrip) {
+    if (!obj.proto || obj.proto.class != "String") {
+      return false;
+    }
+
+    let length = DevToolsUtils.getProperty(obj, "length");
+    if (typeof length != "number") {
+      return false;
+    }
+
+    let raw = obj.unsafeDereference();
+    let str = null;
+    try {
+      str = String.prototype.toString.call(raw);
+    } catch (ex) {
+      // toString() can throw if the raw JS object cannot be represented as
+      // a string.
+      return false;
+    }
+
+    if (str !== null) {
+      str = threadActor.createValueGrip(makeDebuggeeValueIfNeeded(obj, str));
+    }
+
+    aGrip.displayString = str;
+    return true;
+  }],
+
+  Boolean: [function({obj, threadActor}, aGrip) {
+    if (!obj.proto || obj.proto.class != "Boolean") {
+      return false;
+    }
+
+    let raw = obj.unsafeDereference();
+    let bool = null;
+    try {
+      bool = Boolean.prototype.valueOf.call(raw);
+    } catch (ex) {
+      // valueOf() can throw if the raw JS object is "misbehaved".
+      return false;
+    }
+
+    if (bool !== null) {
+      bool = threadActor.createValueGrip(makeDebuggeeValueIfNeeded(obj, bool));
+    }
+
+    aGrip.preview = { value: bool };
+    return true;
+  }],
+
+  Number: [function({obj, threadActor}, aGrip) {
+    if (!obj.proto || obj.proto.class != "Number") {
+      return false;
+    }
+
+    let raw = obj.unsafeDereference();
+    let n = null;
+    try {
+      n = Number.prototype.valueOf.call(raw);
+    } catch (ex) {
+      // valueOf() can throw if the raw JS object is "misbehaved".
+      return false;
+    }
+
+    if (n !== null) {
+      n = threadActor.createValueGrip(makeDebuggeeValueIfNeeded(obj, n));
+    }
+
+    aGrip.preview = { value: n };
+    return true;
+  }],
+
   Function: [function({obj, threadActor}, aGrip) {
     if (obj.name) {
       aGrip.name = obj.name;
     }
 
     if (obj.displayName) {
       aGrip.displayName = obj.displayName.substr(0, 500);
     }
