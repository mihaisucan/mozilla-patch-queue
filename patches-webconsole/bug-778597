# HG changeset patch
# Parent 8c63e260c4faf1d1aefbceab58a640f0881e0158
# User Mihai Sucan <mihai.sucan@gmail.com>
# Date 1343749206 -10800

Bug 778597 - Intermittent browser_webconsole_position_ui.js | Timed out while waiting for: web console position changed to 'window'; try: -b do -p linux,linuxqt,linux64,macosx64,win32,win64,macosx -u mochitest-o -t none

diff --git a/browser/devtools/webconsole/test/browser_webconsole_position_ui.js b/browser/devtools/webconsole/test/browser_webconsole_position_ui.js
--- a/browser/devtools/webconsole/test/browser_webconsole_position_ui.js
+++ b/browser/devtools/webconsole/test/browser_webconsole_position_ui.js
@@ -32,17 +32,17 @@ function testEnd() {
 
 function waitForPosition(aPosition, aCallback) {
   waitForSuccess({
     name: "web console position changed to '" + aPosition + "'",
     validatorFn: function()
     {
       return hudRef._currentUIPosition == aPosition;
     },
-    successFn: aCallback,
+    successFn: executeSoon.bind(null, aCallback),
     failureFn: finishTest,
   });
 }
 
 function consoleOpened(aHudRef) {
   hudRef = aHudRef;
   testMenuitems();
 
@@ -50,19 +50,20 @@ function consoleOpened(aHudRef) {
 
   is(hudBox.parentNode.childNodes[2].getAttribute("id"), hudRef.hudId,
      "initial console position is correct");
 
   is(hudRef.ui.positionMenuitems.below.getAttribute("checked"), "true",
      "position menu checkbox is below");
   is(Services.prefs.getCharPref(POSITION_PREF), "below", "pref is below");
 
-  hudRef.positionConsole("above");
-
-  waitForPosition("above", onPositionAbove);
+  executeSoon(function() {
+    hudRef.positionConsole("above");
+    waitForPosition("above", onPositionAbove);
+  });
 }
 
 function onPositionAbove() {
   let hudBox = hudRef.iframe;
 
   let id = hudBox.parentNode.childNodes[0].getAttribute("id");
   is(id, hudRef.hudId, "above position is correct");
 
@@ -76,18 +77,20 @@ function onPositionAbove() {
   hudBox.style.height = boxHeight + "px";
 
   boxHeight = hudBox.clientHeight;
 
   Services.prefs.setIntPref(WIDTH_PREF, panelWidth);
   Services.prefs.setIntPref(TOP_PREF, 50);
   Services.prefs.setIntPref(LEFT_PREF, 51);
 
-  hudRef.positionConsole("window");
-  waitForPosition("window", onPositionWindow);
+  executeSoon(function() {
+    hudRef.positionConsole("window");
+    waitForPosition("window", onPositionWindow);
+  });
 }
 
 function onPositionWindow() {
   let hudBox = hudRef.iframe;
 
   let id = hudBox.parentNode.getAttribute("id");
   is(id, "console_window_" + hudRef.hudId, "window position is correct");
   is(Services.prefs.getCharPref(POSITION_PREF), "window", "pref is window");
