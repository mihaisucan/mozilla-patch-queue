# HG changeset patch
# Parent 437c7da7c0175e6fd8d01373b9f588f36abf71f7
# User Andrea Marchesini <amarchesini@mozilla.com>
Bug 896535 - Promise: `then(console.log)` is not working as expected

diff --git a/dom/base/ConsoleAPI.js b/dom/base/ConsoleAPI.js
--- a/dom/base/ConsoleAPI.js
+++ b/dom/base/ConsoleAPI.js
@@ -255,17 +255,27 @@ ConsoleAPI.prototype = {
    * @private
    * @param array aCall
    *        Array that holds information about the queued call.
    */
   _processQueuedCall: function CA__processQueuedItem(aCall)
   {
     let [method, args, meta] = aCall;
 
-    let frame = meta.stack[0];
+    let frame;
+    if (meta.stack.length) {
+      frame = meta.stack[0];
+    } else {
+      frame = {
+        filename: '',
+        lineNumber: 0,
+        functionName: '[native code]',
+      };
+    }
+
     let consoleEvent = {
       ID: this._outerID,
       innerID: this._innerID,
       level: method,
       filename: frame.filename,
       lineNumber: frame.lineNumber,
       functionName: frame.functionName,
       timeStamp: meta.timeStamp,
