# HG changeset patch
# Parent 6f3923ed6a4db565b04e743b06109fd930c60457
# User Mihai Sucan <mihai.sucan@gmail.com>
# Date 1395954929 -7200

Bug 989025 - WebConsole breaks when trying to autocomplete in objects from different domains; r=past; try: -b do -p linux,linux64,macosx64,win32,win64 -u xpcshell,mochitest-bc -t none

diff --git a/browser/devtools/webconsole/test/browser.ini b/browser/devtools/webconsole/test/browser.ini
--- a/browser/devtools/webconsole/test/browser.ini
+++ b/browser/devtools/webconsole/test/browser.ini
@@ -105,16 +105,17 @@ support-files =
   testscript.js
   test-bug_923281_console_log_filter.html
   test-bug_923281_test1.js
   test-bug_923281_test2.js
   test-bug_939783_console_trace_duplicates.html
   test-bug-952277-highlight-nodes-in-vview.html
   test-bug-609872-cd-iframe-parent.html
   test-bug-609872-cd-iframe-child.html
+  test-bug-989025-iframe-parent.html
 
 [browser_bug664688_sandbox_update_after_navigation.js]
 [browser_bug_638949_copy_link_location.js]
 [browser_bug_862916_console_dir_and_filter_off.js]
 [browser_bug_865288_repeat_different_objects.js]
 [browser_bug_865871_variables_view_close_on_esc_key.js]
 [browser_bug_869003_inspect_cross_domain_object.js]
 [browser_bug_871156_ctrlw_close_tab.js]
@@ -272,8 +273,9 @@ run-if = os == "mac"
 [browser_webconsole_output_dom_elements_02.js]
 [browser_webconsole_output_dom_elements_03.js]
 [browser_webconsole_output_dom_elements_04.js]
 [browser_webconsole_output_events.js]
 [browser_console_variables_view_highlighter.js]
 [browser_webconsole_start_netmon_first.js]
 [browser_webconsole_console_trace_duplicates.js]
 [browser_webconsole_cd_iframe.js]
+[browser_webconsole_autocomplete_crossdomain_iframe.js]
diff --git a/browser/devtools/webconsole/test/browser_webconsole_autocomplete_crossdomain_iframe.js b/browser/devtools/webconsole/test/browser_webconsole_autocomplete_crossdomain_iframe.js
new file mode 100644
--- /dev/null
+++ b/browser/devtools/webconsole/test/browser_webconsole_autocomplete_crossdomain_iframe.js
@@ -0,0 +1,59 @@
+/* Any copyright is dedicated to the Public Domain.
+   http://creativecommons.org/publicdomain/zero/1.0/ */
+
+// Test that autocomplete doesn't break when trying to reach into objects from
+// a different domain, bug 989025.
+
+function test() {
+  let hud;
+
+  const TEST_URI = "http://example.com/browser/browser/devtools/webconsole/test/test-bug-989025-iframe-parent.html";
+
+  Task.spawn(function*() {
+    const {tab} = yield loadTab(TEST_URI);
+    hud = yield openConsole(tab);
+
+    hud.jsterm.execute('document.title');
+
+    yield waitForMessages({
+      webconsole: hud,
+      messages: [{
+        text: "989025 - iframe parent",
+        category: CATEGORY_OUTPUT,
+      }],
+    });
+
+    let autocompleteUpdated = hud.jsterm.once("autocomplete-updated");
+
+    hud.jsterm.setInputValue("window[0].document");
+    executeSoon(() => {
+      EventUtils.synthesizeKey(".", {});
+    });
+
+    yield autocompleteUpdated;
+
+    hud.jsterm.setInputValue("window[0].document.title");
+    EventUtils.synthesizeKey("VK_RETURN", {});
+
+    yield waitForMessages({
+      webconsole: hud,
+      messages: [{
+        text: "Permission denied",
+        category: CATEGORY_OUTPUT,
+        severity: SEVERITY_ERROR,
+      }],
+    });
+
+    hud.jsterm.execute("window.location");
+
+    yield waitForMessages({
+      webconsole: hud,
+      messages: [{
+        text: "test-bug-989025-iframe-parent.html",
+        category: CATEGORY_OUTPUT,
+      }],
+    });
+
+    yield closeConsole(tab);
+  }).then(finishTest);
+}
diff --git a/browser/devtools/webconsole/test/test-bug-989025-iframe-parent.html b/browser/devtools/webconsole/test/test-bug-989025-iframe-parent.html
new file mode 100644
--- /dev/null
+++ b/browser/devtools/webconsole/test/test-bug-989025-iframe-parent.html
@@ -0,0 +1,13 @@
+<!DOCTYPE html>
+<html lang="en">
+  <head>
+    <meta charset="utf-8">
+    <title>test for bug 989025 - iframe parent</title>
+    <!-- Any copyright is dedicated to the Public Domain.
+         http://creativecommons.org/publicdomain/zero/1.0/ -->
+  </head>
+  <body>
+    <p>test for bug 989025 - iframe parent</p>
+    <iframe src="http://mochi.test:8888/browser/browser/devtools/webconsole/test/test-bug-609872-cd-iframe-child.html"></iframe>
+  </body>
+</html>
diff --git a/toolkit/devtools/webconsole/utils.js b/toolkit/devtools/webconsole/utils.js
--- a/toolkit/devtools/webconsole/utils.js
+++ b/toolkit/devtools/webconsole/utils.js
@@ -1093,17 +1093,17 @@ let DebuggerEnvironmentSupport = {
     } catch (ex) {
       // getVariable() throws for invalid identifiers.
     }
     return result === undefined ? null : { value: result };
   },
 };
 
 
-exports.JSPropertyProvider = JSPropertyProvider;
+exports.JSPropertyProvider = DevToolsUtils.makeInfallible(JSPropertyProvider);
 })(WebConsoleUtils);
 
 ///////////////////////////////////////////////////////////////////////////////
 // The page errors listener
 ///////////////////////////////////////////////////////////////////////////////
 
 /**
  * The nsIConsoleService listener. This is used to send all of the console
